name: Pull Request Check

on:
  pull_request:
    branches: [ main, develop, release/* ]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  MAVEN_OPTS: -Xmx2g -XX:+UseG1GC

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: ç¼“å­˜SonarCloudä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar

    - name: ç¼–ç è§„èŒƒæ£€æŸ¥
      run: |
        echo "::group::Checkstyleæ£€æŸ¥"
        mvn checkstyle:check -B
        echo "::endgroup::"

    - name: ä»£ç é£æ ¼æ£€æŸ¥
      run: |
        echo "::group::Spotlessæ£€æŸ¥"
        mvn spotless:check -B
        echo "::endgroup::"

    - name: Bugæ£€æŸ¥
      run: |
        echo "::group::SpotBugsæ£€æŸ¥"
        mvn spotbugs:check -B
        echo "::endgroup::"

    - name: ä¾èµ–æ¼æ´æ£€æŸ¥
      run: |
        echo "::group::OWASPä¾èµ–æ£€æŸ¥"
        mvn org.owasp:dependency-check-maven:check -B
        echo "::endgroup::"

    - name: SonarCloudåˆ†æ
      if: ${{ env.SONAR_TOKEN != '' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        mvn sonar:sonar -B \
          -Dsonar.projectKey=liuxiao2015_game-server-framework \
          -Dsonar.organization=liuxiao2015 \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.pullrequest.key=${{ github.event.number }} \
          -Dsonar.pullrequest.branch=${{ github.head_ref }} \
          -Dsonar.pullrequest.base=${{ github.base_ref }}

    - name: ä¸Šä¼ ä»£ç è´¨é‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: |
          target/checkstyle-result.xml
          target/spotbugsXml.xml
          target/dependency-check-report.html
        retention-days: 30

  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    strategy:
      matrix:
        java-version: [17, 21]
        os: [ubuntu-latest, windows-latest]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: maven

    - name: ç¼–è¯‘é¡¹ç›®
      run: mvn clean compile -B

    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        mvn test -B \
          -Dmaven.test.failure.ignore=false \
          -Djacoco.skip=false

    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: |
        mvn verify -B \
          -DskipUnitTests=true \
          -Dfailsafe.rerunFailingTestsCount=2

    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      if: always()
      run: |
        mvn surefire-report:report-only -B
        mvn failsafe-report:report-only -B

    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-java${{ matrix.java-version }}-${{ matrix.os }}
        path: |
          target/surefire-reports/
          target/failsafe-reports/
          target/site/
        retention-days: 30

    - name: ä¸Šä¼ ä»£ç è¦†ç›–ç‡
      if: matrix.java-version == '21' && matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@v3
      with:
        file: target/site/jacoco/jacoco.xml
        flags: unittests
        name: codecov-umbrella

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: æ„å»ºé¡¹ç›®
      run: mvn clean compile -B -DskipTests

    - name: CodeQLåˆ†æåˆå§‹åŒ–
      uses: github/codeql-action/init@v3
      with:
        languages: java

    - name: CodeQLè‡ªåŠ¨æ„å»º
      uses: github/codeql-action/autobuild@v3

    - name: æ‰§è¡ŒCodeQLåˆ†æ
      uses: github/codeql-action/analyze@v3

    - name: Snykæ¼æ´æ‰«æ
      uses: snyk/actions/maven@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

    - name: ä¸Šä¼ SnykæŠ¥å‘Š
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: snyk.sarif

  # Dockeræ„å»ºæµ‹è¯•
  docker-build:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: æ„å»ºDockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: gameserver:pr-${{ github.event.number }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: é•œåƒå®‰å…¨æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: gameserver:pr-${{ github.event.number }}
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ä¸Šä¼ é•œåƒæ‰«æç»“æœ
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false && contains(github.event.pull_request.labels.*.name, 'performance')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: å¯åŠ¨æµ‹è¯•æœåŠ¡
      run: |
        mvn clean package -B -DskipTests
        java -jar launcher/target/*.jar &
        sleep 30

    - name: è¿è¡ŒJMeteræ€§èƒ½æµ‹è¯•
      uses: rbhadti94/apache-jmeter-action@v0.5.0
      with:
        testFilePath: src/test/jmeter/performance-test.jmx
        outputReportsFolder: target/jmeter-reports

    - name: ä¸Šä¼ æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-reports
        path: target/jmeter-reports/
        retention-days: 30

  # æ–‡æ¡£æ£€æŸ¥
  docs-check:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ£€æŸ¥æ–‡æ¡£é“¾æ¥
      uses: lycheeverse/lychee-action@v1.8.0
      with:
        args: --verbose --no-progress '**/*.md'

    - name: æ£€æŸ¥æ‹¼å†™é”™è¯¯
      uses: streetsidesoftware/cspell-action@v5
      with:
        files: |
          **/*.md
          **/*.java
        config: .cspell.json

  # PRè¯„è®ºæ±‡æ€»
  pr-comment:
    runs-on: ubuntu-latest
    needs: [code-quality, build-and-test, security-scan, docker-build]
    if: always() && github.event.pull_request.draft == false
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æµ‹è¯•æŠ¥å‘Š
      uses: actions/download-artifact@v4
      with:
        path: ./reports

    - name: ç”ŸæˆPRè¯„è®º
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
          const jobs = [
            { name: 'ä»£ç è´¨é‡æ£€æŸ¥', status: '${{ needs.code-quality.result }}' },
            { name: 'æ„å»ºå’Œæµ‹è¯•', status: '${{ needs.build-and-test.result }}' },
            { name: 'å®‰å…¨æ‰«æ', status: '${{ needs.security-scan.result }}' },
            { name: 'Dockeræ„å»º', status: '${{ needs.docker-build.result }}' }
          ];
          
          const getStatusEmoji = (status) => {
            switch (status) {
              case 'success': return 'âœ…';
              case 'failure': return 'âŒ';
              case 'cancelled': return 'â¹ï¸';
              case 'skipped': return 'â­ï¸';
              default: return 'â³';
            }
          };
          
          let comment = `## ğŸš€ PRæ£€æŸ¥ç»“æœ\n\n`;
          comment += `| æ£€æŸ¥é¡¹ | çŠ¶æ€ | ç»“æœ |\n`;
          comment += `|--------|------|------|\n`;
          
          jobs.forEach(job => {
            comment += `| ${job.name} | ${getStatusEmoji(job.status)} | ${job.status} |\n`;
          });
          
          comment += `\n### ğŸ“Š è¯¦ç»†ä¿¡æ¯\n\n`;
          comment += `- **æäº¤**: ${context.sha.substring(0, 7)}\n`;
          comment += `- **åˆ†æ”¯**: ${context.payload.pull_request.head.ref}\n`;
          comment += `- **æ£€æŸ¥æ—¶é—´**: ${new Date().toISOString()}\n`;
          
          // æ·»åŠ å¤±è´¥çš„æç¤º
          const failedJobs = jobs.filter(job => job.status === 'failure');
          if (failedJobs.length > 0) {
            comment += `\n### âš ï¸ å¤±è´¥çš„æ£€æŸ¥\n\n`;
            failedJobs.forEach(job => {
              comment += `- ${job.name}: è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—è¿›è¡Œä¿®å¤\n`;
            });
          }
          
          comment += `\n---\n`;
          comment += `> æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ`;
          
          // æŸ¥æ‰¾ç°æœ‰è¯„è®º
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('PRæ£€æŸ¥ç»“æœ')
          );
          
          if (botComment) {
            // æ›´æ–°ç°æœ‰è¯„è®º
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            // åˆ›å»ºæ–°è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
          }

  # è‡ªåŠ¨åˆå¹¶æ£€æŸ¥
  auto-merge-check:
    runs-on: ubuntu-latest
    needs: [code-quality, build-and-test, security-scan, docker-build]
    if: |
      always() && 
      github.event.pull_request.draft == false &&
      contains(github.event.pull_request.labels.*.name, 'auto-merge') &&
      needs.code-quality.result == 'success' &&
      needs.build-and-test.result == 'success' &&
      needs.security-scan.result == 'success' &&
      needs.docker-build.result == 'success'
    
    steps:
    - name: è‡ªåŠ¨åˆå¹¶å‡†å¤‡
      uses: actions/github-script@v7
      with:
        script: |
          const { data: reviews } = await github.rest.pulls.listReviews({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number,
          });
          
          const approvedReviews = reviews.filter(review => 
            review.state === 'APPROVED' && review.user.type !== 'Bot'
          );
          
          if (approvedReviews.length >= 1) {
            console.log('PRå·²è·å¾—æ‰¹å‡†ï¼Œæ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥è‡ªåŠ¨åˆå¹¶');
            
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              commit_title: `è‡ªåŠ¨åˆå¹¶: ${context.payload.pull_request.title}`,
              commit_message: `ç”±GitHub Actionsè‡ªåŠ¨åˆå¹¶\n\nPR #${context.payload.pull_request.number}`,
              merge_method: 'squash'
            });
            
            console.log('PRå·²è‡ªåŠ¨åˆå¹¶');
          } else {
            console.log('PRéœ€è¦è‡³å°‘1ä¸ªæ‰¹å‡†æ‰èƒ½è‡ªåŠ¨åˆå¹¶');
          }